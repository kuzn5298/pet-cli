#!/bin/bash
#
# pet-wake-from-waker - Wake a sleeping project (called by pet-waker.js)
#
# Usage: pet-wake-from-waker <project-name>
# Outputs: port number on success, exits with error on failure
#

# Don't use set -e, handle errors manually for better error messages

PET_DIR="${PET_DIR:-$HOME/.pet-cli}"
PET_CONFIG_DIR="${PET_CONFIG_DIR:-$HOME/.config/pet}"

# Setup systemd user session environment
# Required for systemctl --user to work from service context
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
export DBUS_SESSION_BUS_ADDRESS="${DBUS_SESSION_BUS_ADDRESS:-unix:path=$XDG_RUNTIME_DIR/bus}"

# Colors (disabled for script output)
RED=''
GREEN=''
YELLOW=''
BLUE=''
CYAN=''
NC=''

# Debug log function - writes to stderr so it doesn't interfere with port output
debug() {
    echo "[wake-debug] $*" >&2
}

debug "Starting wake for: $1"
debug "PET_DIR=$PET_DIR"
debug "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR"

# Load utils
if ! source "$PET_DIR/lib/utils.sh" 2>/dev/null; then
    echo "Error: Failed to load utils from $PET_DIR/lib/utils.sh" >&2
    exit 1
fi
debug "Utils loaded"

name="$1"

if [ -z "$name" ]; then
    echo "Error: Project name required" >&2
    exit 1
fi

# Check project exists
if ! project_exists "$name"; then
    echo "Error: Project $name not found" >&2
    exit 1
fi
debug "Project exists"

# Load config - redirect stderr to avoid exit messages
config_file="$(get_project_config "$name")"
if [ ! -f "$config_file" ]; then
    echo "Error: Config file not found: $config_file" >&2
    exit 1
fi
source "$config_file"
debug "Config loaded: PORT=$PROJECT_PORT"

# Check if actually sleeping
if ! is_project_sleeping "$name"; then
    debug "Not sleeping, returning port"
    echo "$PROJECT_PORT"
    exit 0
fi
debug "Project is sleeping, waking up"

# Start the service
debug "Starting service pet-${name}.service"
start_result=$(systemctl --user start "pet-${name}.service" 2>&1)
start_code=$?
debug "systemctl returned: code=$start_code output=$start_result"

if [ $start_code -ne 0 ]; then
    echo "Error: Failed to start service (code $start_code): $start_result" >&2
    exit 1
fi

# Wait for service to be ready
max_attempts=30
attempt=0
debug "Waiting for service to be ready"

while [ $attempt -lt $max_attempts ]; do
    status=$(get_service_status "$name")
    debug "Attempt $attempt: status=$status"

    if [ "$status" = "active" ]; then
        # Check if responding
        if curl -s -o /dev/null --connect-timeout 1 "http://127.0.0.1:${PROJECT_PORT}/" 2>/dev/null; then
            debug "Service is responding"
            break
        fi
    elif [ "$status" = "failed" ]; then
        echo "Error: Service failed to start" >&2
        exit 1
    fi

    sleep 1
    attempt=$((attempt + 1))
done

if [ $attempt -ge $max_attempts ]; then
    echo "Error: Service startup timeout" >&2
    exit 1
fi
debug "Service is ready"

# Switch nginx back to service
conf="/etc/nginx/sites-available/pet-${name}.conf"
if [ -f "$conf" ]; then
    # Restore original upstream port
    sudo sed -i "s|server 127.0.0.1:3999; # sleeping: original port ${PROJECT_PORT}|server 127.0.0.1:${PROJECT_PORT};|" "$conf" 2>/dev/null || true

    # Remove sleep header
    sudo sed -i "/X-Pet-Sleep-Project/d" "$conf" 2>/dev/null || true

    # Reload nginx
    sudo nginx -t 2>/dev/null && sudo systemctl reload nginx 2>/dev/null || true
fi

# Update status
set_sleep_status "$name" "awake"

# Output port for waker to proxy to
echo "$PROJECT_PORT"
