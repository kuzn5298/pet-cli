#!/bin/bash
#
# pet-cli - Simple Node.js project manager with sleep support
# https://github.com/username/pet-cli
#

set -e

VERSION="1.2.5"
PET_DIR="${PET_DIR:-$HOME/.pet-cli}"
PET_CONFIG_DIR="${PET_CONFIG_DIR:-$HOME/.config/pet}"
LIB_DIR="$PET_DIR/lib"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Load library modules
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/deploy.sh"
source "$LIB_DIR/setup.sh"
source "$LIB_DIR/status.sh"
source "$LIB_DIR/logs.sh"
source "$LIB_DIR/nginx.sh"
source "$LIB_DIR/crashes.sh"
source "$LIB_DIR/config.sh"
source "$LIB_DIR/sleep.sh"

# Show help
show_help() {
    cat << 'EOF'
pet-cli - Simple Node.js project manager with sleep support

USAGE:
    pet <command> [options]

COMMANDS:
    setup <name>          Full setup (dir + db + nginx + ssl)
    deploy <name>         Deploy a new project
    status [name]         Show status of all or specific project
    list                  List all projects (short)
    start <name>          Start/wake a project
    stop <name>           Stop a project
    restart <name>        Restart a project
    enable <name>         Enable a disabled project
    disable <name>        Fully disable a project
    remove <name>         Remove project from management

    sleep <name>          Put project to sleep (saves resources)
    wake <name>           Wake up a sleeping project
    sleep-service         Manage waker/sleeper services

    logs <name>           Show project logs
    crashes [name]        Show crash history

    config <name>         Show/edit project configuration

    nginx <name>          Manage nginx configuration

    update                Update pet-cli from git
    version               Show version

SETUP OPTIONS:
    --port <N>            Port number (required for proxy)
    --domain <domain>     Domain name for nginx + SSL
    --db <user:pass>      Create PostgreSQL database
    --dir <path>          Project directory (default: /opt/apps/<name>)
    --cmd <command>       Start command (default: node dist/main.js)
    --memory <limit>      Memory limit (default: 100M)
    --always-on           Keep running (no sleep)
    --spa                 SPA type (static + routing)
    --static              Static file type (CDN)

CONFIG OPTIONS:
    --sleep               Enable sleep mode (auto-sleep when inactive)
    --no-sleep            Disable sleep mode
    --sleep-timeout <T>   Inactivity timeout (e.g., 30m, 1h)

SLEEP-SERVICE:
    pet sleep-service start    Start waker and sleeper services
    pet sleep-service stop     Stop waker and sleeper services
    pet sleep-service restart  Restart services
    pet sleep-service status   Show services and sleeping projects status

EXAMPLES:
    pet setup my-api --port 3000 --domain api.example.com --db user:pass --always-on
    pet setup my-spa --spa --domain app.example.com
    pet config my-api --sleep --sleep-timeout 30m
    pet sleep-service start
    pet sleep my-api
    pet wake my-api
    pet status
    pet logs my-api -f

EOF
}

# Main command router
main() {
    local command="${1:-}"
    shift || true

    case "$command" in
        setup)
            cmd_setup "$@"
            ;;
        deploy)
            cmd_deploy "$@"
            ;;
        status|st)
            cmd_status "$@"
            ;;
        list|ls)
            cmd_list "$@"
            ;;
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        restart)
            cmd_restart "$@"
            ;;
        enable)
            cmd_enable "$@"
            ;;
        disable)
            cmd_disable "$@"
            ;;
        remove|rm)
            cmd_remove "$@"
            ;;
        sleep)
            cmd_sleep "$@"
            ;;
        wake)
            cmd_wake "$@"
            ;;
        sleep-service)
            cmd_sleep_service "$@"
            ;;
        logs|log)
            cmd_logs "$@"
            ;;
        crashes)
            cmd_crashes "$@"
            ;;
        config|cfg)
            cmd_config "$@"
            ;;
        nginx)
            cmd_nginx "$@"
            ;;
        update)
            cmd_update "$@"
            ;;
        version|--version|-v)
            echo "pet-cli v$VERSION"
            echo "Installed: $PET_DIR"
            ;;
        help|--help|-h)
            show_help
            ;;
        "")
            show_help
            exit 1
            ;;
        *)
            echo -e "${RED}Unknown command: $command${NC}"
            echo "Run 'pet help' for usage"
            exit 1
            ;;
    esac
}

# Update command
cmd_update() {
    echo -e "${CYAN}⟳ Updating pet-cli...${NC}"

    cd "$PET_DIR"

    # Reset any local changes (generated/modified files)
    echo "  Resetting local changes..."
    git checkout . 2>/dev/null || true
    git clean -fd 2>/dev/null || true

    git fetch origin

    local LOCAL=$(git rev-parse HEAD)
    local REMOTE=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master)

    if [ "$LOCAL" = "$REMOTE" ]; then
        echo -e "${GREEN}✓ pet-cli is up to date (v$VERSION)${NC}"
    else
        echo "  Pulling changes..."
        git pull

        if [ -f "$PET_DIR/install.sh" ]; then
            echo "  Running install.sh..."
            bash "$PET_DIR/install.sh"
        fi

        echo -e "${GREEN}✓ pet-cli updated${NC}"
    fi
}

# Run main
main "$@"
